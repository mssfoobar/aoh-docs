"use strict";(self.webpackChunkaoh_documentation=self.webpackChunkaoh_documentation||[]).push([[3843],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(n),m=o,h=c["".concat(s,".").concat(m)]||c[m]||d[m]||r;return n?a.createElement(h,i(i({ref:t},u),{},{components:n})):a.createElement(h,i({ref:t},u))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[c]="string"==typeof e?e:o,i[1]=l;for(var p=2;p<r;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},18679:(e,t,n)=>{n.d(t,{Z:()=>i});var a=n(67294),o=n(86010);const r="tabItem_Ymn6";function i(e){let{children:t,hidden:n,className:i}=e;return a.createElement("div",{role:"tabpanel",className:(0,o.Z)(r,i),hidden:n},t)}},34259:(e,t,n)=>{n.d(t,{Z:()=>m});var a=n(87462),o=n(67294),r=n(86010),i=n(51048),l=n(33609),s=n(1943),p=n(72957);const u="tabList__CuJ",c="tabItem_LNqP";function d(e){const{lazy:t,block:n,defaultValue:i,values:d,groupId:m,className:h}=e,k=o.Children.map(e.children,(e=>{if((0,o.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})),y=d??k.map((e=>{let{props:{value:t,label:n,attributes:a}}=e;return{value:t,label:n,attributes:a}})),g=(0,l.l)(y,((e,t)=>e.value===t.value));if(g.length>0)throw new Error(`Docusaurus error: Duplicate values "${g.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`);const v=null===i?i:i??k.find((e=>e.props.default))?.props.value??k[0].props.value;if(null!==v&&!y.some((e=>e.value===v)))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${v}" but none of its children has the corresponding value. Available values are: ${y.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);const{tabGroupChoices:f,setTabGroupChoices:N}=(0,s.U)(),[w,b]=(0,o.useState)(v),C=[],{blockElementScrollPositionUntilNextRender:E}=(0,p.o5)();if(null!=m){const e=f[m];null!=e&&e!==w&&y.some((t=>t.value===e))&&b(e)}const T=e=>{const t=e.currentTarget,n=C.indexOf(t),a=y[n].value;a!==w&&(E(t),b(a),null!=m&&N(m,String(a)))},K=e=>{let t=null;switch(e.key){case"Enter":T(e);break;case"ArrowRight":{const n=C.indexOf(e.currentTarget)+1;t=C[n]??C[0];break}case"ArrowLeft":{const n=C.indexOf(e.currentTarget)-1;t=C[n]??C[C.length-1];break}}t?.focus()};return o.createElement("div",{className:(0,r.Z)("tabs-container",u)},o.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":n},h)},y.map((e=>{let{value:t,label:n,attributes:i}=e;return o.createElement("li",(0,a.Z)({role:"tab",tabIndex:w===t?0:-1,"aria-selected":w===t,key:t,ref:e=>C.push(e),onKeyDown:K,onClick:T},i,{className:(0,r.Z)("tabs__item",c,i?.className,{"tabs__item--active":w===t})}),n??t)}))),t?(0,o.cloneElement)(k.filter((e=>e.props.value===w))[0],{className:"margin-top--md"}):o.createElement("div",{className:"margin-top--md"},k.map(((e,t)=>(0,o.cloneElement)(e,{key:t,hidden:e.props.value!==w})))))}function m(e){const t=(0,i.Z)();return o.createElement(d,(0,a.Z)({key:String(t)},e))}},56313:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>s,default:()=>m,frontMatter:()=>l,metadata:()=>p,toc:()=>c});var a=n(87462),o=(n(67294),n(3905)),r=n(34259),i=n(18679);const l={sidebar_position:1},s="Service Creation",p={unversionedId:"development/app/services",id:"development/app/services",title:"Service Creation",description:"This section provides step-by-step instructions on how you can create a new service in the AGIL Ops Hub framework.",source:"@site/docs/development/app/1-services.md",sourceDirName:"development/app",slug:"/development/app/services",permalink:"/aoh-docs/docs/development/app/services",draft:!1,editUrl:"https://github.com/mssfoobar/aoh-docs/tree/main/docs/development/app/1-services.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"development",previous:{title:"\ud83d\udda5\ufe0f Backend Applications",permalink:"/aoh-docs/docs/category/\ufe0f-backend-applications"},next:{title:"Service Deployment",permalink:"/aoh-docs/docs/development/app/deployment"}},u={},c=[{value:"Pre-requisites",id:"pre-requisites",level:2},{value:"Recommended Tools:",id:"recommended-tools",level:4},{value:"Required Tools:",id:"required-tools",level:4},{value:"1. Setting up the repository",id:"1-setting-up-the-repository",level:2},{value:"Create a new repository for your service from the template",id:"create-a-new-repository-for-your-service-from-the-template",level:3},{value:"1.1 Clone the repository",id:"11-clone-the-repository",level:3},{value:"1.2 Renaname the repository",id:"12-renaname-the-repository",level:3},{value:"1.3 Change the <code>.git</code> repository to your own new one",id:"13-change-the-git-repository-to-your-own-new-one",level:3},{value:"2. Create a Keycloak client for your service",id:"2-create-a-keycloak-client-for-your-service",level:2},{value:"2.1 Prepare information and executables",id:"21-prepare-information-and-executables",level:3},{value:"2.1.1 Install <code>jq</code> if you don&#39;t have it (it is a json query)",id:"211-install-jq-if-you-dont-have-it-it-is-a-json-query",level:4},{value:"2.1.2 Get all the information you need for your service",id:"212-get-all-the-information-you-need-for-your-service",level:3},{value:"2.1.3 Run the quickstart script",id:"213-run-the-quickstart-script",level:3},{value:"2.2 Set Keycloak client information",id:"22-set-keycloak-client-information",level:3},{value:"2.3 Prepare credentials to create Keycloak client",id:"23-prepare-credentials-to-create-keycloak-client",level:3},{value:"2.4 Create the Keycloak client",id:"24-create-the-keycloak-client",level:3},{value:"2.6 Create the new role for the Keycloak client",id:"26-create-the-new-role-for-the-keycloak-client",level:3},{value:"2.7 Create the new group for the Keycloak client",id:"27-create-the-new-group-for-the-keycloak-client",level:3},{value:"2.7 Create the group-role mapping",id:"27-create-the-group-role-mapping",level:3},{value:"2.8 Put the new service account into the group",id:"28-put-the-new-service-account-into-the-group",level:3},{value:"3 Configure Internal Table Permissions",id:"3-configure-internal-table-permissions",level:2},{value:"4. Understanding the Project Structure",id:"4-understanding-the-project-structure",level:2},{value:"cmd",id:"cmd",level:3},{value:"pkg",id:"pkg",level:3},{value:"docker",id:"docker",level:3},{value:"docker-compose",id:"docker-compose",level:3},{value:"5. Start writing your service",id:"5-start-writing-your-service",level:2},{value:"5.1 Create a new <code>.env</code> file",id:"51-create-a-new-env-file",level:3},{value:"5.2 Update the template service&#39;s names to your new service&#39;s name",id:"52-update-the-template-services-names-to-your-new-services-name",level:3},{value:"6. Provide a readiness and liveness endpoint",id:"6-provide-a-readiness-and-liveness-endpoint",level:2},{value:"7. Handling CORS",id:"7-handling-cors",level:2},{value:"8. Preparing your service for deployment",id:"8-preparing-your-service-for-deployment",level:2},{value:"9. Documenting your service",id:"9-documenting-your-service",level:2}],d={toc:c};function m(e){let{components:t,...l}=e;return(0,o.kt)("wrapper",(0,a.Z)({},d,l,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"service-creation"},"Service Creation"),(0,o.kt)("p",null,"This section provides step-by-step instructions on how you can create a new service in the ",(0,o.kt)("inlineCode",{parentName:"p"},"AGIL Ops Hub")," framework."),(0,o.kt)("h2",{id:"pre-requisites"},"Pre-requisites"),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Pay careful attention to the ",(0,o.kt)("inlineCode",{parentName:"p"},"wsl")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"Git")," requirements - all the commands are written for ",(0,o.kt)("strong",{parentName:"p"},"Linux"),". To follow\nthe steps painlessly on a Windows system, you should install ",(0,o.kt)("inlineCode",{parentName:"p"},"wsl")," and run the commands in the ",(0,o.kt)("inlineCode",{parentName:"p"},"wsl")," terminal. Also,\nmake sure ",(0,o.kt)("inlineCode",{parentName:"p"},"Git"),"'s credential manager is set up to use ",(0,o.kt)("inlineCode",{parentName:"p"},"Windows Credential Manager"),". The steps to do this is\nstraightforward and available in the links provided in the ",(0,o.kt)("a",{parentName:"p",href:"#required-tools"},"Required Tools")," section.")),(0,o.kt)("h4",{id:"recommended-tools"},"Recommended Tools:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("a",{parentName:"p",href:"https://code.visualstudio.com/download"},"Visual Studio Code")),(0,o.kt)("p",{parentName:"li"},"A popular text editor with many integrations with the technologies we use. Alternatively, you may use your preferred\ntext editor."))),(0,o.kt)("h4",{id:"required-tools"},"Required Tools:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/windows/wsl/install"},"Windows Subsystem for Linux (Ubuntu Distribution)")),(0,o.kt)("p",{parentName:"li"},"If you are running on a Windows system, you'll want to install the Ubuntu distribution of WSL\n(Windows Subsystem for Linux). This is because we'll be giving you Linux commands and scripts to\nsimplify/standardize the steps required to get the project up and running."),(0,o.kt)("p",{parentName:"li"},"If you are comfortable with running the equivalent commands on Windows, you may skip this requirement, however,\nwe have scripts/commands ready (e.g. curl-ing the Keycloak Admin API endpoints) for you to run in Linux that might\nbe troublesome to perform on Windows.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("a",{parentName:"p",href:"https://go.dev/"},"Go")),(0,o.kt)("p",{parentName:"li"},"Golang runtime required for development.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("a",{parentName:"p",href:"https://git-scm.com/downloads"},"Git")),(0,o.kt)("p",{parentName:"li"},"Our version control system for source code. This is installed in Ubuntu by default. If you're using Windows, please\ninstall it. You can use GitHub Desktop or your favourite GUI package for this as well."),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/windows/wsl/tutorials/wsl-git#git-credential-manager-setup"},"https://learn.microsoft.com/en-us/windows/wsl/tutorials/wsl-git#git-credential-manager-setup")),(0,o.kt)("p",{parentName:"li"},"If you're using WSL, follow the above tutorial to ensure ",(0,o.kt)("inlineCode",{parentName:"p"},"git")," in WSL works seamlessly with Windows. This means any\npassword you use when working with ",(0,o.kt)("inlineCode",{parentName:"p"},"git")," on Windows will also work in WSL.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("a",{parentName:"p",href:"https://www.docker.com/products/docker-desktop/"},"Docker Desktop")),(0,o.kt)("p",{parentName:"li"},"Contains the container run-time for container images as well as a user-interface for managing containers, and many\nmore additional features such as ",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose"),", etc.\nEven if you are extremely familiar with containerization,\n",(0,o.kt)("a",{parentName:"p",href:"https://www.docker.com/products/container-runtime/"},"Docker Engine")," alone will probably not be enough as we use\n",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose"),"."))),(0,o.kt)("h2",{id:"1-setting-up-the-repository"},"1. Setting up the repository"),(0,o.kt)("h3",{id:"create-a-new-repository-for-your-service-from-the-template"},"Create a new repository for your service from the template"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"image",src:n(48389).Z,width:"774",height:"576"})),(0,o.kt)("p",null,"The following repositories exist as GitHub templates, if you are hosting your source code on GitHub, you can go to\nthe respective repository links and click ",(0,o.kt)("inlineCode",{parentName:"p"},"Use this template")," to create a new repository directly from the template,\notherwise, you may use the steps below to clone and create a new ",(0,o.kt)("inlineCode",{parentName:"p"},"git")," repository."),(0,o.kt)("h3",{id:"11-clone-the-repository"},"1.1 Clone the repository"),(0,o.kt)("p",null,"Refer to the pre-requisite section on how to set up ",(0,o.kt)("inlineCode",{parentName:"p"},"git")," in WSL if your credentials in Windows are not being recognized\nin WSL."),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"Members contributing directly to AGIL Ops Hub will should have access to the repositories in ",(0,o.kt)("inlineCode",{parentName:"p"},"mssfoobar"),". Members of\nother projects will require access to the same repository in a different organisation."),(0,o.kt)("p",{parentName:"admonition"},"If you do not have access to the following repositories, approach the maintainers of ",(0,o.kt)("inlineCode",{parentName:"p"},"AOH")," to request for access.")),(0,o.kt)(r.Z,{mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"1",label:"AGIL Ops Hub",default:!0,mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/mssfoobar/aoh-service-template\n"))),(0,o.kt)(i.Z,{value:"2",label:"Other Projects",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/DoisKoh/aoh-service-template\n")))),(0,o.kt)("h3",{id:"12-renaname-the-repository"},"1.2 Renaname the repository"),(0,o.kt)("p",null,"This example assumes you are creating a service called ",(0,o.kt)("inlineCode",{parentName:"p"},"solveallyourproblems"),". You should also replace ",(0,o.kt)("inlineCode",{parentName:"p"},"aoh")," with your project or\norganisation name."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"mv aoh-service-template aoh-solveallyourproblems\n")),(0,o.kt)("h3",{id:"13-change-the-git-repository-to-your-own-new-one"},"1.3 Change the ",(0,o.kt)("inlineCode",{parentName:"h3"},".git")," repository to your own new one"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cd aoh-solveallyourproblems\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"rm -rf .git\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"git init\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"git checkout -b main\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"git add .\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'git commit -m "initial commit"\n')),(0,o.kt)("p",null,"Replace ",(0,o.kt)("inlineCode",{parentName:"p"},"[your-remote-url]")," with the actual URL of your remote Git repository (e.g.\ngit remote set-url origin ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/mssfoobar/aoh-solveallyourproblems"},"https://github.com/mssfoobar/aoh-solveallyourproblems"),")"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"}," git remote set-url origin [your-remote-url]\n")),(0,o.kt)("h2",{id:"2-create-a-keycloak-client-for-your-service"},"2. Create a Keycloak client for your service"),(0,o.kt)("p",null,"Your new service will need to authenticate itself with Keycloak in order to access other services in our system (e.g.\nto connect to Hasura to write or read data in the database). To do this, it needs to register itself with Keycloak as a\nnew client and exchange its credentials for an access token that must be sent with each request to other services."),(0,o.kt)("h3",{id:"21-prepare-information-and-executables"},"2.1 Prepare information and executables"),(0,o.kt)("h4",{id:"211-install-jq-if-you-dont-have-it-it-is-a-json-query"},"2.1.1 Install ",(0,o.kt)("inlineCode",{parentName:"h4"},"jq")," if you don't have it (it is a json query)"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"sudo apt install jq\n")),(0,o.kt)("h3",{id:"212-get-all-the-information-you-need-for-your-service"},"2.1.2 Get all the information you need for your service"),(0,o.kt)("p",null,"Prepare the following information:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Service ID (e.g. aoh_solveallyourproblems)"),(0,o.kt)("li",{parentName:"ul"},"Service Label (e.g. AGIL Ops Hub Solve All Your Problems Service)"),(0,o.kt)("li",{parentName:"ul"},"Service Description (e.g. This service will solve all your problems.)"),(0,o.kt)("li",{parentName:"ul"},"Keycloak Username: This is the username to log in to your admin user in Keycloak (e.g. user)"),(0,o.kt)("li",{parentName:"ul"},"Keycloak Password: This is the password to log in to your admin user in Keycloak (e.g. password123)"),(0,o.kt)("li",{parentName:"ul"},"Keycloak URL: This is the address of your Keycloak server (e.g. ",(0,o.kt)("a",{parentName:"li",href:"http://iam.dev.aoh"},"http://iam.dev.aoh"),")"),(0,o.kt)("li",{parentName:"ul"},"Keycloak Realm: This is the Keycloak realm for your project (e.g. aoh)")),(0,o.kt)("h3",{id:"213-run-the-quickstart-script"},"2.1.3 Run the quickstart script"),(0,o.kt)("p",null,"Ensure you are in the ",(0,o.kt)("inlineCode",{parentName:"p"},"./config")," folder, it contains the following template configuration files that are used in the\nensuing commands:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"client.json"),(0,o.kt)("li",{parentName:"ul"},"group.json"),(0,o.kt)("li",{parentName:"ul"},"role.json"),(0,o.kt)("li",{parentName:"ul"},"quickstart.sh")),(0,o.kt)("p",null,"The last file is a ",(0,o.kt)("inlineCode",{parentName:"p"},"quickstart")," script that you can run to perform all the commands in section ",(0,o.kt)("inlineCode",{parentName:"p"},"2.")),(0,o.kt)("p",null,"If you can successfully run this script, you can skip steps ",(0,o.kt)("inlineCode",{parentName:"p"}," 2.2")," - ",(0,o.kt)("inlineCode",{parentName:"p"},"2.8"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"./quickstart.sh\n")),(0,o.kt)("p",null,"The successful command will return you the ",(0,o.kt)("inlineCode",{parentName:"p"},"Client UUID"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"Client Secret")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"Client Service Account Name"),"."),(0,o.kt)("p",null,"You should copy this secret and place it in your ",(0,o.kt)("inlineCode",{parentName:"p"},".env")," file in step ",(0,o.kt)("inlineCode",{parentName:"p"},"5.1")," to save you the trouble of executing the\ncommand to retrieve the secret again."),(0,o.kt)("h3",{id:"22-set-keycloak-client-information"},"2.2 Set Keycloak client information"),(0,o.kt)("p",null,"Change the values for ",(0,o.kt)("inlineCode",{parentName:"p"},"CLIENT_ID"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"CLIENT_NAME")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"CLIENT_DESC")," based on what's appropriate for your service."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'CLIENT_ID="aoh_solveallyourproblems"\nCLIENT_NAME="AGIL Ops Hub Solve All Your Problems Service"\nCLIENT_DESC="This service will solve all your problems."\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'jq ".clientId = \\"$CLIENT_ID\\" |\n .name = \\"$CLIENT_NAME\\" |\n .description = \\"$CLIENT_DESC\\"" \\\n client.json > new_client.json && mv new_client.json client.json\n')),(0,o.kt)("h3",{id:"23-prepare-credentials-to-create-keycloak-client"},"2.3 Prepare credentials to create Keycloak client"),(0,o.kt)("p",null,"The commands will log you in to Keycloak and retrieve an access token, then use that access token to create a client for\nyour new service based on the ",(0,o.kt)("inlineCode",{parentName:"p"},"client.json")," file we just created in\n",(0,o.kt)("a",{parentName:"p",href:"#22-prepare-keycloak-client-information"},"step 2.2"),". Replace the ",(0,o.kt)("inlineCode",{parentName:"p"},"[username]"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"[password]"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"[url]"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"[realm]")," with\nyour appropriate Keycloak credentials."),(0,o.kt)("p",null,"Example: KEYCLOAK_USERNAME=user"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"KEYCLOAK_USERNAME=[username]\n")),(0,o.kt)("p",null,"Example: KEYCLOAK_PASSWORD=password123"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"KEYCLOAK_PASSWORD=[password]\n")),(0,o.kt)("p",null,"Ensure there is ",(0,o.kt)("strong",{parentName:"p"},"no trailing slash")," (e.g. ",(0,o.kt)("inlineCode",{parentName:"p"},"http://iam.dev.aoh")," not ",(0,o.kt)("inlineCode",{parentName:"p"},"http://iam.dev.aoh/"),")"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"KEYCLOAK_URL=[url]\n")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"If you use the wrong ",(0,o.kt)("inlineCode",{parentName:"p"},"KEYCLOAK_URL"),", such as if you point to a site that doesn't exist, ",(0,o.kt)("inlineCode",{parentName:"p"},"curl")," will not reliably know that\nis erroneous. You will likely get a blank output. If you are having problems, please double-check that your ",(0,o.kt)("inlineCode",{parentName:"p"},"KEYCLOAK_URL")," is\npointing your correct Keycloak server host.")),(0,o.kt)("p",null,"Example: KEYCLOAK_REALM=aoh"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"KEYCLOAK_REALM=[realm]\n")),(0,o.kt)("p",null,"With all the variables prepared, we can execute the following command to store the access token in the ",(0,o.kt)("inlineCode",{parentName:"p"},"TOKEN")," variable."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'TOKEN="$(curl -s -X POST -H "Content-Type: application/x-www-form-urlencoded" \\\n-d "username=$KEYCLOAK_USERNAME&password=$KEYCLOAK_PASSWORD&grant_type=password&client_id=admin-cli" \\\n$KEYCLOAK_URL/realms/master/protocol/openid-connect/token | jq -r ".access_token")"\n')),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"This token expires after 1 minute. After which you will need to execute this command again to refresh the token. Some\nsubsequent commands in this guide still requires the token - in the scenario that they don't work, run this command\nagain to update the token.")),(0,o.kt)("h3",{id:"24-create-the-keycloak-client"},"2.4 Create the Keycloak client"),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"If you are returned an error saying you are unauthorized - you might have keyed in the wrong user/password, or your\ntoken might have expired. If it expired, just execute\n",(0,o.kt)("a",{parentName:"p",href:"#23-prepare-credentials-to-create-keycloak-client"},"the command to set the token")," again.")),(0,o.kt)("p",null,"Note that if successful, the following command does not give any feedback."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'curl -s -X POST -H "Content-Type: application/json" -H "Authorization: Bearer $TOKEN" -d @./client.json \\\n$KEYCLOAK_URL/admin/realms/$KEYCLOAK_REALM/clients\n')),(0,o.kt)("p",null,"If you wish to confirm that your client was created, you can execute the following commands to retrieve the client (the\ncommand assumes you have ",(0,o.kt)("inlineCode",{parentName:"p"},"TOKEN"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"KEYCLOAK_URL"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"KEYCLOAK_REALM")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"CLIENT_ID")," set)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'curl -s -X GET -H "Content-Type: application/x-www-form-urlencoded" \\\n-H "Authorization: Bearer $TOKEN" \\\n$KEYCLOAK_URL/admin/realms/$KEYCLOAK_REALM/clients/?clientId=$CLIENT_ID | jq -r ".[0]"\n\n')),(0,o.kt)("h3",{id:"26-create-the-new-role-for-the-keycloak-client"},"2.6 Create the new role for the Keycloak client"),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"If you are returned an error saying you are unauthorized - you might have keyed in the wrong user/password, or your\ntoken might have expired. If it expired, just execute\n",(0,o.kt)("a",{parentName:"p",href:"#23-prepare-credentials-to-create-keycloak-client"},"the command to set the token")," again.")),(0,o.kt)("p",null,"The following commands are required to set your new client's service account's role."),(0,o.kt)("p",null,"Prepare the data for the new role:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'jq ".name = \\"$CLIENT_ID\\" |\n .description = \\"$ROLE_DESC\\"" \\\n role.json > new_role.json && mv new_role.json role.json\n')),(0,o.kt)("p",null,"This will create the new role for your service in Keycloak:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'curl -s -X POST -H "Content-Type: application/json" \\\n-H "Authorization: Bearer $TOKEN" \\\n-d @./role.json \\\n$KEYCLOAK_URL/admin/realms/$KEYCLOAK_REALM/roles\n')),(0,o.kt)("h3",{id:"27-create-the-new-group-for-the-keycloak-client"},"2.7 Create the new group for the Keycloak client"),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"If you are returned an error saying you are unauthorized - you might have keyed in the wrong user/password, or your\ntoken might have expired. If it expired, just execute\n",(0,o.kt)("a",{parentName:"p",href:"#23-prepare-credentials-to-create-keycloak-client"},"the command to set the token")," again.")),(0,o.kt)("p",null,"The following commands are required to set your new client's service account's group."),(0,o.kt)("p",null,"Prepare the data for the new group:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'jq ".name = \\"$CLIENT_ID\\" |\n .path = \\"/$CLIENT_ID\\" |\n .attributes.\\"default-role\\"[0] = \\"$CLIENT_ID\\" |\n .realmRoles[0] = \\"$CLIENT_ID\\"" \\\n group.json > new_group.json && mv new_group.json group.json\n')),(0,o.kt)("p",null,"This will create the new group for your service in Keycloak:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'curl -s -X POST -H "Content-Type: application/json" \\\n-H "Authorization: Bearer $TOKEN" \\\n-d @./group_config.json \\\n$KEYCLOAK_URL/admin/realms/$KEYCLOAK_REALM/groups\n')),(0,o.kt)("h3",{id:"27-create-the-group-role-mapping"},"2.7 Create the group-role mapping"),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"If you are returned an error saying you are unauthorized - you might have keyed in the wrong user/password, or your\ntoken might have expired. If it expired, just execute\n",(0,o.kt)("a",{parentName:"p",href:"#23-prepare-credentials-to-create-keycloak-client"},"the command to set the token")," again.")),(0,o.kt)("p",null,"The following commands are to tie the group with the role. This is required for the correct claims to be generated."),(0,o.kt)("p",null,"Get the ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," of the client (not the same as ",(0,o.kt)("inlineCode",{parentName:"p"},"CLIENT_ID"),"):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'CLIENT_UUID="$(curl -s -X GET -H "Content-Type: application/json" \\\n-H "Authorization: Bearer $TOKEN" \\\n$KEYCLOAK_URL/admin/realms/$KEYCLOAK_REALM/clients/?clientId=$CLIENT_ID | jq -r ".[0].id")"\n')),(0,o.kt)("p",null,"Get the role id:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'ROLE_ID=$(curl -s -X GET -H "Content-Type: application/x-www-form-urlencoded" \\\n-H "Authorization: Bearer $TOKEN" \\\n$KEYCLOAK_URL/admin/realms/$KEYCLOAK_REALM/roles | jq -r ".[] | select(.name == \\"$CLIENT_ID\\").id")\n')),(0,o.kt)("p",null,"Get the group id:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'GROUP_ID=$(curl -s -X GET -H "Content-Type: application/x-www-form-urlencoded" \\\n-H "Authorization: Bearer $TOKEN" \\\n$KEYCLOAK_URL/admin/realms/$KEYCLOAK_REALM/groups | jq -r ".[] | select(.name == \\"$CLIENT_ID\\").id")\n')),(0,o.kt)("p",null,"Get the service account's user id:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'SERVICE_ACC_ID=$(curl -s -X GET -H "Content-Type: application/x-www-form-urlencoded" \\\n-H "Authorization: Bearer $TOKEN" \\\n$KEYCLOAK_URL/admin/realms/$KEYCLOAK_REALM/clients/$CLIENT_UUID/service-account-user | jq -r ".id")\n')),(0,o.kt)("p",null,"Create group-role mapping:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'curl -s -X POST -H "Content-Type: application/json" \\\n-H "Authorization: Bearer $TOKEN" \\\n-d "[{ \\"id\\": \\"$ROLE_ID\\", \\"name\\": \\"$CLIENT_ID\\" }]" \\\n$KEYCLOAK_URL/admin/realms/$KEYCLOAK_REALM/groups/$GROUP_ID/role-mappings/realm\n')),(0,o.kt)("h3",{id:"28-put-the-new-service-account-into-the-group"},"2.8 Put the new service account into the group"),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"If you are returned an error saying you are unauthorized - you might have keyed in the wrong user/password, or your\ntoken might have expired. If it expired, just execute\n",(0,o.kt)("a",{parentName:"p",href:"#23-prepare-credentials-to-create-keycloak-client"},"the command to set the token")," again.")),(0,o.kt)("p",null,"Put your new service client into the group:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'curl -s -X PUT -H "Content-Type: application/x-www-form-urlencoded" \\\n-H "Authorization: Bearer $TOKEN" \\\n$KEYCLOAK_URL/admin/realms/$KEYCLOAK_REALM/users/$SERVICE_ACC_ID/groups/$GROUP_ID\n')),(0,o.kt)("p",null,"This will now allow your service account to have the correct scopes to access the system with its new role."),(0,o.kt)("h2",{id:"3-configure-internal-table-permissions"},"3 Configure Internal Table Permissions"),(0,o.kt)("p",null,"TODO: The permission for the role must be configured in Hasura - configure CRUD access to desired tables."),(0,o.kt)("p",null,"Refer to the following link on how to configure permissions in Hasura:\n",(0,o.kt)("a",{parentName:"p",href:"https://hasura.io/docs/latest/auth/authorization/permissions/"},"https://hasura.io/docs/latest/auth/authorization/permissions/")),(0,o.kt)("h2",{id:"4-understanding-the-project-structure"},"4. Understanding the Project Structure"),(0,o.kt)("p",null,"Below is a summary of our project structure, which follows Golang's standards. For more information, see:\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/golang-standards/project-layout"},"https://github.com/golang-standards/project-layout")),(0,o.kt)("h3",{id:"cmd"},"cmd"),(0,o.kt)("p",null,"This is where the application code sits. This typically calls reusable packages from the ",(0,o.kt)("inlineCode",{parentName:"p"},"pkg")," folder. If you have\ntypes, classes, etc. that can be reused in other applications, it should reside in ",(0,o.kt)("inlineCode",{parentName:"p"},"pkg")," instead."),(0,o.kt)("p",null,"It's common for ",(0,o.kt)("inlineCode",{parentName:"p"},"cmd")," to have a small ",(0,o.kt)("inlineCode",{parentName:"p"},"main")," function that simply imports code from ",(0,o.kt)("inlineCode",{parentName:"p"},"pkg"),"."),(0,o.kt)("h3",{id:"pkg"},"pkg"),(0,o.kt)("p",null,"This should contain library code that can be used by other applications. Ideally, your package code could function as\nan SDK which can be imported and used in other Golang projects to access and process data in ",(0,o.kt)("inlineCode",{parentName:"p"},"AOH"),"."),(0,o.kt)("h3",{id:"docker"},"docker"),(0,o.kt)("p",null,"Your service may contain multiple packages in your ",(0,o.kt)("inlineCode",{parentName:"p"},"pkg")," folder, each of these packages should have its own Dockerfile.\nIn this sample, we'll just have one called ",(0,o.kt)("inlineCode",{parentName:"p"},"service.Dockerfile"),", you should rename this accordingly.\n(e.g. ",(0,o.kt)("inlineCode",{parentName:"p"},"solveallyourproblems.Dockerfile"),")"),(0,o.kt)("h3",{id:"docker-compose"},"docker-compose"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose")," file contains all the information needed for Docker to build a container image for your service.\nYou will need to"),(0,o.kt)("h2",{id:"5-start-writing-your-service"},"5. Start writing your service"),(0,o.kt)("p",null,"Congratulations, you can now start writing your service. Compiling and running your service requires the ",(0,o.kt)("inlineCode",{parentName:"p"},"Go")," tool,\nwhich you should already have installed. See ",(0,o.kt)("a",{parentName:"p",href:"#required-tools"},"required tools")," above. Without the ",(0,o.kt)("inlineCode",{parentName:"p"},"Go")," tool, you won't\nbe able to build or run your ",(0,o.kt)("inlineCode",{parentName:"p"},"Go")," program."),(0,o.kt)("p",null,"You may use any IDE you're comfortable with (such as ",(0,o.kt)("a",{parentName:"p",href:"https://www.jetbrains.com/go/"},"GoLand"),"), however, we recommend\nVisual Studio Code to keep all of us on the same development environment, which makes troubleshooting simpler."),(0,o.kt)("h3",{id:"51-create-a-new-env-file"},"5.1 Create a new ",(0,o.kt)("inlineCode",{parentName:"h3"},".env")," file"),(0,o.kt)("p",null,"This environment file is not meant to be checked in, and is used entirely for your local development. A sample ",(0,o.kt)("inlineCode",{parentName:"p"},".env"),"\nfile is provided to you called ",(0,o.kt)("inlineCode",{parentName:"p"},".env.sample"),", with all the default environment variables we used to set up the\ndatabase connection. Copy this file and rename it to ",(0,o.kt)("inlineCode",{parentName:"p"},".env"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cp .env.sample .env\n")),(0,o.kt)("p",null,"Then, open the file and fill in the values accordingly. One of the values you will require is the client secret. You can\neither use the Keycloak admin UI to retrieve this, or run the following script:"),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"This assumes you already have ",(0,o.kt)("inlineCode",{parentName:"p"},"TOKEN"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"KEYCLOAK_USERNAME"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"KEYCLOAK_PASSWORD"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"KEYCLOAK_URL"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"KEYCLOAK_REALM"),",\n",(0,o.kt)("inlineCode",{parentName:"p"},"CLIENT_ID"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"CLIENT_UUID")," variables set. Otherwise, refer to ",(0,o.kt)("a",{parentName:"p",href:"#22-prepare-keycloak-client-information"},"section 2.3"),"\nand ",(0,o.kt)("a",{parentName:"p",href:"#24-create-the-keycloak-client"},"section 2.4")," for details on how they should be set.")),(0,o.kt)("p",null,"Use the token and the ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," to get the secret:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'curl -s -X GET -H "Content-Type: application/json" \\\n-H "Authorization: Bearer $TOKEN " \\\n$KEYCLOAK_URL/admin/realms/$KEYCLOAK_REALM/clients/$CLIENT_UUID/client-secret | echo IAM_CLIENT_SECRET is: $(jq -r ".value")\n')),(0,o.kt)("h3",{id:"52-update-the-template-services-names-to-your-new-services-name"},"5.2 Update the template service's names to your new service's name"),(0,o.kt)("p",null,"To get started, search for the text ",(0,o.kt)("inlineCode",{parentName:"p"},"TODO")," in the template project - in VSCode, the hotkey is ",(0,o.kt)("inlineCode",{parentName:"p"},"Ctrl + Shift + F")," to\nsearch for text in all folders. There, you'll find comments on what you should replace (mostly code relating to\nthe name of your service, and the name of the Go module)"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"./go.mod\nUpdate your module name."),(0,o.kt)("li",{parentName:"ul"},"./cmd/service-name/main.go\nRename the 'service-name' folder appropriately (to whatever your package should be called)"),(0,o.kt)("li",{parentName:"ul"},"./pkg/constants\nAdd or remove any constants required."),(0,o.kt)("li",{parentName:"ul"},"./docker/service.Dockerfile\nRename all the occurrances of ",(0,o.kt)("inlineCode",{parentName:"li"},"servicename")," to an appropriate name for your service. Alsom add any additional build\nsteps if required."),(0,o.kt)("li",{parentName:"ul"},"./docker-compose.yml\nAdd any additional environment variables your service might need.")),(0,o.kt)("h2",{id:"6-provide-a-readiness-and-liveness-endpoint"},"6. Provide a readiness and liveness endpoint"),(0,o.kt)("p",null,"Every service is required to provide a readiness and liveness endpoint. The purpose of these is so Kubernetes can\nperiodically hit these endpoints to check if your service is alive, or ready."),(0,o.kt)("p",null,"Reference: ",(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/"},"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/")),(0,o.kt)("p",null,"The template code provides these endpoints to you via the ",(0,o.kt)("inlineCode",{parentName:"p"},"/v1/info/liveness")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"/v1/info/readiness")," endpoints."),(0,o.kt)("p",null,"You will likely not need to change the ",(0,o.kt)("inlineCode",{parentName:"p"},"liveness")," endpoint, however, if your services requires additional information\nor steps to perform before it is ready to serve requests, you will need to make sure that all these steps are done\nbefore you return a ",(0,o.kt)("inlineCode",{parentName:"p"},"200 OK")," on the ",(0,o.kt)("inlineCode",{parentName:"p"},"readiness")," endpoint."),(0,o.kt)("h2",{id:"7-handling-cors"},"7. Handling CORS"),(0,o.kt)("p",null,"// TODO, check how we wanted to standardize this with @dleeha"),(0,o.kt)("h2",{id:"8-preparing-your-service-for-deployment"},"8. Preparing your service for deployment"),(0,o.kt)("p",null,"It is the responsibility of developers to ensure that their ",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," file is fully up to date and that their\nservices can be built and run as a container."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},".github/workflows")," folder contains GitHub actions to automatically build your service into a container image and\ndeploy this container image to ",(0,o.kt)("inlineCode",{parentName:"p"},"ghcr.io")," (GitHub container registry), the scripts therein should be managed by your\nDevOps engineer (which may or may not be you as well) and"),(0,o.kt)("h2",{id:"9-documenting-your-service"},"9. Documenting your service"),(0,o.kt)("p",null,"Your service should be documented as in Open API 3.1 yaml file. Our workflow consists of us creating Postman Collections\nto share and test our API's, then converting them to Open API 3.1 files and"))}m.isMDXComponent=!0},48389:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/create-repository-from-template-f3d98f6aef3f6a1a1c855aa7cdaf90aa.png"}}]);