"use strict";(self.webpackChunkaoh_documentation=self.webpackChunkaoh_documentation||[]).push([[9605],{85881:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>o,toc:()=>d});var s=i(74848),c=i(28453);const t={sidebar_position:2},l="Administering OIDC Clients",o={id:"iam/clients",title:"Administering OIDC Clients",description:"When you create a new service that needs access to the system, you need to create an OIDC client for that service. This",source:"@site/docs/50_iam/20_clients.md",sourceDirName:"50_iam",slug:"/iam/clients",permalink:"/aoh-docs/docs/iam/clients",draft:!1,unlisted:!1,editUrl:"https://github.com/mssfoobar/aoh-docs/tree/main/docs/50_iam/20_clients.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"iam",previous:{title:"\ud83c\udd95 Introduction",permalink:"/aoh-docs/docs/iam/introduction"},next:{title:"Roles & Groups",permalink:"/aoh-docs/docs/iam/roles_and_groups"}},r={},d=[{value:"Creating an OIDC client",id:"creating-an-oidc-client",level:2},{value:"Configuring the client",id:"configuring-the-client",level:2},{value:"Adding mappers",id:"adding-mappers",level:3},{value:"Manage Service Account Group Mappings",id:"manage-service-account-group-mappings",level:3},{value:"Get an access token to make system calls",id:"get-an-access-token-to-make-system-calls",level:3}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",ul:"ul",...(0,c.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"administering-oidc-clients",children:"Administering OIDC Clients"}),"\n",(0,s.jsxs)(n.p,{children:["When you create a new service that needs access to the system, you need to create an OIDC client for that service. This\nwill allow access to the system as a user or account associated with that client. For services, we give them access to\nthe system via ",(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/server_admin/#_service_accounts",children:"service accounts"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"This section describes how you can create an OIDC client for a new service, enable a service account for the OIDC\nclient, and fetch an access token for the service account to grant you access to the system."}),"\n",(0,s.jsx)(n.h2,{id:"creating-an-oidc-client",children:"Creating an OIDC client"}),"\n",(0,s.jsx)(n.p,{children:"The steps for creating a client is as follows:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Click ",(0,s.jsx)(n.code,{children:"Clients"})," in the menu on the left"]}),"\n",(0,s.jsxs)(n.li,{children:["Click ",(0,s.jsx)(n.code,{children:"Create client"})]}),"\n",(0,s.jsxs)(n.li,{children:["Choose a client ID - We prefix the client ID with the domain, for example ",(0,s.jsx)(n.code,{children:"aoh_web"}),". This is not a Keycloak requirement but a naming\nconvention we follow."]}),"\n",(0,s.jsx)(n.li,{children:"Give it a sensible name and description"}),"\n",(0,s.jsxs)(n.li,{children:["Scroll down to ",(0,s.jsx)(n.code,{children:"Capability config"})," and make sure ",(0,s.jsx)(n.code,{children:"Client authentication"})," is on and ",(0,s.jsx)(n.code,{children:"Service accounts roles"})," is\nchecked."]}),"\n",(0,s.jsx)(n.li,{children:"Click save."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"configuring-the-client",children:"Configuring the client"}),"\n",(0,s.jsxs)(n.p,{children:["You will need to configure your new client to add mappers to have claims added to the token that will let you access\nHasura in our system. Read more about authentication in AOH ",(0,s.jsx)(n.a,{href:"/docs/iam/introduction#authentication-in-agil-ops-hub",children:"here"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"adding-mappers",children:"Adding mappers"}),"\n",(0,s.jsxs)(n.p,{children:["Add the ",(0,s.jsx)(n.code,{children:"x-hasura-default-role"}),", ",(0,s.jsx)(n.code,{children:"x-hasura-allowed-roles"})," and ",(0,s.jsx)(n.code,{children:"x-hausra-client-id"})," mappers."]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Click ",(0,s.jsx)(n.code,{children:"Clients"})," in the menu on the left"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Click on the client you want to configure"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Click the ",(0,s.jsx)(n.code,{children:"Client scopes"})," tab"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Under ",(0,s.jsx)(n.code,{children:"Assigned client scope"}),", you will be able to see ",(0,s.jsx)(n.code,{children:"[client-id]-dedicated"})," as a link, click it to access the"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Adding the ",(0,s.jsx)(n.code,{children:"x-hasura-default-role"})," mapper:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["5.1. Click ",(0,s.jsx)(n.code,{children:"Add mapper"})]}),"\n",(0,s.jsxs)(n.li,{children:["5.2. Click ",(0,s.jsx)(n.code,{children:"By configuration"})]}),"\n",(0,s.jsxs)(n.li,{children:["5.3. Click ",(0,s.jsx)(n.code,{children:"User Attribute"})]}),"\n",(0,s.jsxs)(n.li,{children:["5.4 Key in 'default-role' in ",(0,s.jsx)(n.code,{children:"User Attribute"})]}),"\n",(0,s.jsxs)(n.li,{children:["5.5 Key in 'hasura_access.x-hasura-default-role' in ",(0,s.jsx)(n.code,{children:"Token Claim Name"})]}),"\n",(0,s.jsxs)(n.li,{children:["5.6 Leave ",(0,s.jsx)(n.code,{children:"Claim JSON Type"})," as String"]}),"\n",(0,s.jsxs)(n.li,{children:["5.7 Leave ",(0,s.jsx)(n.code,{children:"Add to ID token"})," checked"]}),"\n",(0,s.jsxs)(n.li,{children:["5.8 Leave ",(0,s.jsx)(n.code,{children:"Add to access token"})," checked"]}),"\n",(0,s.jsxs)(n.li,{children:["5.9 Leave ",(0,s.jsx)(n.code,{children:"Add to userinfo"})," checked\nmappers and scope."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Adding the ",(0,s.jsx)(n.code,{children:"x-hasura-allowed-roles"})," mapper:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["6.1. Click ",(0,s.jsx)(n.code,{children:"Add mapper"})]}),"\n",(0,s.jsxs)(n.li,{children:["6.2. Click ",(0,s.jsx)(n.code,{children:"By configuration"})]}),"\n",(0,s.jsxs)(n.li,{children:["6.3. Click ",(0,s.jsx)(n.code,{children:"User Realm Role"})]}),"\n",(0,s.jsxs)(n.li,{children:["6.4 Leave ",(0,s.jsx)(n.code,{children:"Multivalued"})," checked"]}),"\n",(0,s.jsxs)(n.li,{children:["6.5 Key in 'hasura_access.x-hasura-allowed-roles' in ",(0,s.jsx)(n.code,{children:"Token Claim Name"})]}),"\n",(0,s.jsxs)(n.li,{children:["6.6 Leave ",(0,s.jsx)(n.code,{children:"Claim JSON Type"})," as String"]}),"\n",(0,s.jsxs)(n.li,{children:["6.7 Leave ",(0,s.jsx)(n.code,{children:"Add to ID token"})," checked"]}),"\n",(0,s.jsxs)(n.li,{children:["6.8 Leave ",(0,s.jsx)(n.code,{children:"Add to access token"})," checked"]}),"\n",(0,s.jsxs)(n.li,{children:["6.9 Leave ",(0,s.jsx)(n.code,{children:"Add to userinfo"})," checked"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Adding the ",(0,s.jsx)(n.code,{children:"x-hasura-client-id"})," mapper:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["7.1. Click ",(0,s.jsx)(n.code,{children:"Add mapper"})]}),"\n",(0,s.jsxs)(n.li,{children:["7.2. Click ",(0,s.jsx)(n.code,{children:"By configuration"})]}),"\n",(0,s.jsxs)(n.li,{children:["7.3. Click ",(0,s.jsx)(n.code,{children:"User Session Note"})]}),"\n",(0,s.jsxs)(n.li,{children:["7.4 Key in 'clientId' in ",(0,s.jsx)(n.code,{children:"User Session Note"})]}),"\n",(0,s.jsxs)(n.li,{children:["7.5 Key in 'hasura_access.x-hasura-client-id' in ",(0,s.jsx)(n.code,{children:"Token Claim Name"})]}),"\n",(0,s.jsxs)(n.li,{children:["7.6 Leave ",(0,s.jsx)(n.code,{children:"Claim JSON Type"})," as String"]}),"\n",(0,s.jsxs)(n.li,{children:["7.7 Leave ",(0,s.jsx)(n.code,{children:"Add to ID token"})," checked"]}),"\n",(0,s.jsxs)(n.li,{children:["7.8 Leave ",(0,s.jsx)(n.code,{children:"Add to access token"})," checked"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"manage-service-account-group-mappings",children:"Manage Service Account Group Mappings"}),"\n",(0,s.jsxs)(n.p,{children:["We use the ",(0,s.jsx)(n.code,{children:"system"})," role for backend services. For the mappers to work, the service account must have the right\nattributes on it. We create groups and add the attributes we want to it - this will get merged into the user attributes\nwhen a user joins the group, and the mappers we made in the earlier section will map that to the appropraite claims."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"image",src:i(68684).A+"",width:"1446",height:"583"})}),"\n",(0,s.jsx)(n.p,{children:"To get the service account to join the group:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Click ",(0,s.jsx)(n.code,{children:"Clients"})," in the menu on the left"]}),"\n",(0,s.jsx)(n.li,{children:"Click on the client you want to configure"}),"\n",(0,s.jsxs)(n.li,{children:["Click the ",(0,s.jsx)(n.code,{children:"Service account roles"})," tab"]}),"\n",(0,s.jsxs)(n.li,{children:["Click on the link that says 'To manage detail and group mappings, click on the username\n",(0,s.jsx)(n.code,{children:"<service-account-client-id>"}),"', this will take you to the user details page of the service account"]}),"\n",(0,s.jsxs)(n.li,{children:["Click on the ",(0,s.jsx)(n.code,{children:"Groups"})," tab"]}),"\n",(0,s.jsxs)(n.li,{children:["Click on ",(0,s.jsx)(n.code,{children:"Join Group"})," and check ",(0,s.jsx)(n.code,{children:"system"})," (or any other groups you wish to join)"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"get-an-access-token-to-make-system-calls",children:"Get an access token to make system calls"}),"\n",(0,s.jsxs)(n.p,{children:["You can get your access token by calling the OIDC endpoint called ",(0,s.jsx)(n.code,{children:"token"}),", this can be discovered via the OIDC\ndiscovery endpoint ",(0,s.jsx)(n.code,{children:"GET /.well-known/openid-configuration"})," (read more about\n",(0,s.jsx)(n.a,{href:"https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfigurationRequest",children:"OIDC to learn more"}),")."]}),"\n",(0,s.jsx)(n.p,{children:"One of the endpoints you will get in return is the token endpoint - which should look like this:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.code,{children:"http://<your-keycloak-origin>/realms/<your-realm>/protocol/openid-connect/token"})}),"\n",(0,s.jsx)(n.p,{children:"To make the request, you will need your client credentials, which you can get from the credentials tab in the client\ndetails page:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"image",src:i(29562).A+"",width:"1339",height:"728"})}),"\n",(0,s.jsx)(n.p,{children:"To get to this page:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Click ",(0,s.jsx)(n.code,{children:"Clients"})]}),"\n",(0,s.jsxs)(n.li,{children:["Click on the desired client id in the ",(0,s.jsx)(n.code,{children:"Clients list"})]}),"\n",(0,s.jsxs)(n.li,{children:["Click on the ",(0,s.jsx)(n.code,{children:"credentials"})," tab"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Make a ",(0,s.jsx)(n.code,{children:"POST"})," request to that endpoint, passing in the body:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["client_id: The ID of your client (e.g. ",(0,s.jsx)(n.code,{children:"aoh_web"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:["grant_type: ",(0,s.jsx)(n.code,{children:"client_credentials"})]}),"\n",(0,s.jsx)(n.li,{children:"client_secret: The secret of your client (retrieved from the client credentials page)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The returned result is the access token which you can use as a bearer token to make calls in the system (Hasura)."})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},29562:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/keycloak_client_details_credentials-c2dba54718c26b041717be8fdac69172.jpg"},68684:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/keycloak_group_attributes-a5da9991b031c1493a23638b2d413119.jpg"},28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>o});var s=i(96540);const c={},t=s.createContext(c);function l(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:l(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);