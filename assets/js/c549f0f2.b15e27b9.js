"use strict";(self.webpackChunkaoh_documentation=self.webpackChunkaoh_documentation||[]).push([[6936],{37814:(e,s,a)=>{a.r(s),a.d(s,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>o,toc:()=>l});var n=a(74848),t=a(28453);const r={sidebar_position:60},i="Setup AOH Applications",o={id:"deployment/platform-aoh/setup-aoh-applications",title:"Setup AOH Applications",description:"This section covers the setup of AOH.",source:"@site/docs/30_deployment/70-platform-aoh/60-setup-aoh-applications.md",sourceDirName:"30_deployment/70-platform-aoh",slug:"/deployment/platform-aoh/setup-aoh-applications",permalink:"/aoh-docs/docs/deployment/platform-aoh/setup-aoh-applications",draft:!1,unlisted:!1,editUrl:"https://github.com/mssfoobar/aoh-docs/tree/main/docs/30_deployment/70-platform-aoh/60-setup-aoh-applications.md",tags:[],version:"current",sidebarPosition:60,frontMatter:{sidebar_position:60},sidebar:"deployment",previous:{title:"prepare-aoh-setup",permalink:"/aoh-docs/docs/deployment/platform-aoh/prepare-aoh-setup"},next:{title:"Configure AOH Applications",permalink:"/aoh-docs/docs/deployment/platform-aoh/configure-aoh-applications"}},c={},l=[{value:"Install Foundation Services",id:"install-foundation-services",level:2},{value:"Install ArgoCD",id:"install-argocd",level:3},{value:"log into Argocd",id:"log-into-argocd",level:3},{value:"Add the necessary repo into ArgoCD",id:"add-the-necessary-repo-into-argocd",level:3},{value:"Create aoh storage class",id:"create-aoh-storage-class",level:3},{value:"If the steps above failed, check if the following Databases exists",id:"if-the-steps-above-failed-check-if-the-following-databases-exists",level:3},{value:"For replay",id:"for-replay",level:3},{value:"Init (mass)",id:"init-mass",level:3},{value:"Certs",id:"certs",level:3},{value:"Prepare Keycloak",id:"prepare-keycloak",level:3},{value:"Generate the Client secret and place them into the aws secrets under \u201ciam\u201d",id:"generate-the-client-secret-and-place-them-into-the-aws-secrets-under-iam",level:3},{value:"Change Client Access setting in Keycloak,",id:"change-client-access-setting-in-keycloak",level:3},{value:"Check Hasura system endpoints (should already deployed when DB is deployed)",id:"check-hasura-system-endpoints-should-already-deployed-when-db-is-deployed",level:3},{value:"Reload Hasura metadata",id:"reload-hasura-metadata",level:3},{value:"create nats stream for RnR",id:"create-nats-stream-for-rnr",level:3}];function d(e){const s={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.h1,{id:"setup-aoh-applications",children:"Setup AOH Applications"}),"\n",(0,n.jsx)(s.p,{children:"This section covers the setup of AOH.\nIt starts off with ArgoCD as it is used as the main CD mechanism to deploy entire AOH.\nArgoCD deploys:"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"Foundation Services"}),"\n",(0,n.jsx)(s.li,{children:"Application Services"}),"\n"]}),"\n",(0,n.jsx)(s.h2,{id:"install-foundation-services",children:"Install Foundation Services"}),"\n",(0,n.jsx)(s.h3,{id:"install-argocd",children:"Install ArgoCD"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:'# Create namespace\nkubectl create namespace argocd\n \n# Deploy\nkubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml\n \n# Get ArgoCD access credentials\nkubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d; echo\n\n# Forward UI for access\nkubectl port-forward --address localhost -n argocd svc/argocd-server 19080:80\n'})}),"\n",(0,n.jsx)(s.h3,{id:"log-into-argocd",children:"log into Argocd"}),"\n",(0,n.jsxs)(s.p,{children:["Log into Argocd using the command below:\n",(0,n.jsx)(s.code,{children:"argocd login <ipaddress:port> --name <name> --password <password>"})]}),"\n",(0,n.jsx)(s.h3,{id:"add-the-necessary-repo-into-argocd",children:"Add the necessary repo into ArgoCD"}),"\n",(0,n.jsx)(s.p,{children:"Obtain the latest list from the product team"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"argocd repo add https://github.com/mssfoobar/<repo> --username <username> --password <git_key> --insecure-skip-server-verification\n"})}),"\n",(0,n.jsx)(s.h3,{id:"create-aoh-storage-class",children:"Create aoh storage class"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"cd /ar2-infra/argocd/<clustername>/init/k8s\nkubectl apply -f sc\u2014retain.yml\n \ncd /ar2-infra/argocd/<clustername>/\n# Add root and project manifests (triggers sync)\nkubectl apply -f root-app-<clustername>.yml\nkubectl apply -f projects/project-<clustername>.yml\n"})}),"\n",(0,n.jsx)(s.h1,{id:"prepare-db",children:"Prepare DB"}),"\n",(0,n.jsxs)(s.p,{children:["Extract the files from the DB deployment package obtained from ",(0,n.jsx)(s.a,{href:"https://github.com/mssfoobar/aoh-db",children:"https://github.com/mssfoobar/aoh-db"}),"."]}),"\n",(0,n.jsxs)(s.p,{children:["Follow the instructions to deploy the Database schema, essential data, demo data and Hasura schema.\n",(0,n.jsx)(s.a,{href:"https://github.com/mssfoobar/aoh-db",children:"https://github.com/mssfoobar/aoh-db"})]}),"\n",(0,n.jsx)(s.h3,{id:"if-the-steps-above-failed-check-if-the-following-databases-exists",children:"If the steps above failed, check if the following Databases exists"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"ar2"}),"\n",(0,n.jsx)(s.li,{children:"temporal"}),"\n",(0,n.jsx)(s.li,{children:"temporal-visibility"}),"\n"]}),"\n",(0,n.jsx)(s.h3,{id:"for-replay",children:"For replay"}),"\n",(0,n.jsx)(s.p,{children:"If record and replay is required, the following Database must be created:"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"ar2 (replay Database)"}),"\n",(0,n.jsx)(s.li,{children:"ar2_reader (Main Database)"}),"\n",(0,n.jsx)(s.li,{children:"ar2_reader (replay Database)"}),"\n",(0,n.jsx)(s.li,{}),"\n"]}),"\n",(0,n.jsx)(s.h3,{id:"init-mass",children:"Init (mass)"}),"\n",(0,n.jsxs)(s.p,{children:["folder: ",(0,n.jsx)(s.code,{children:"/ar2-infra/argocd/<clustername>/init/"})]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"# Init general secrets\nkubectl apply -f external_secrets/secrets\n\n# Init minio secrets\nkubectl apply -f minio\n\n# Deploy Traefik\nkubectl create ns traefik\nhelm repo add traefik https://traefik.github.io/charts\nhelm install traefik traefik/traefik -f traefik/values-xxx-x.yml \u2013namespace traefik\n"})}),"\n",(0,n.jsx)(s.h3,{id:"certs",children:"Certs"}),"\n",(0,n.jsxs)(s.p,{children:["For Projects that needs to install certificates, refer to traefik documentations to where to place the certificates to be used.\n",(0,n.jsx)(s.a,{href:"https://doc.traefik.io/traefik/https/tls/",children:"https://doc.traefik.io/traefik/https/tls/"})]}),"\n",(0,n.jsx)(s.h3,{id:"prepare-keycloak",children:"Prepare Keycloak"}),"\n",(0,n.jsx)(s.p,{children:"//NOTE: requires MINIO, AWS secrets, Keycloak initialisation"}),"\n",(0,n.jsxs)(s.p,{children:["Put ",(0,n.jsx)(s.code,{children:"stengg.agiirad.keycloak.user.*#*#*#*#*.jar"})," file into minio bucket ",(0,n.jsx)(s.code,{children:"common-iam/public"}),"\nUpload it within bucket of ",(0,n.jsx)(s.code,{children:"common-iam"})," while creating a folder named ",(0,n.jsx)(s.code,{children:"public"})]}),"\n",(0,n.jsxs)(s.p,{children:["Log into keycloak",(0,n.jsx)(s.br,{}),"\n","Regen user key in keycloak and update into aws secrets:",(0,n.jsx)(s.br,{}),"\n","In Keycload, go to Clients,"]}),"\n",(0,n.jsxs)(s.p,{children:["For client iam secret:",(0,n.jsx)(s.br,{}),"\n","Place into aws_secrets:"]}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.code,{children:".common-rnr.iam.client_secret : <secrets>"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.code,{children:".aoh_web.iam.client_secret : <secrets>"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.code,{children:".ar2_web.iam.client_secret : <secrets>"})}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:"Go into Minio -> Identity -> Users\nRegenatrate the Access keys and place it into the follow Aws-secrets:"}),"\n",(0,n.jsx)(s.p,{children:"For commmon-iam:\nRegen the key,\nPlace into aws_secrets:"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.code,{children:".common-iam.store.access_key : <secrets>"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.code,{children:".common-iam.store.secret_key : <secrets>"})}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:"For commmon-rnr:\nRegen the key,\nPlace into aws_secrets:"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.code,{children:".common-rnr.store.access_key : <secrets>"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.code,{children:".common-rnr.store.secret_key : <secrets>"})}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:"For ar2-ucs:\nregen the key and place into:"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.code,{children:".ar2-ucs.store.access_key : <secrets>"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.code,{children:".ar2-ucs.store.secret_key : <secrets>"})}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.img,{alt:"kc1",src:a(29562).A+"",width:"1339",height:"728"})}),"\n",(0,n.jsx)(s.h3,{id:"generate-the-client-secret-and-place-them-into-the-aws-secrets-under-iam",children:"Generate the Client secret and place them into the aws secrets under \u201ciam\u201d"}),"\n",(0,n.jsx)(s.p,{children:"json file (re-11clean.json) to be imported from keycloak console"}),"\n",(0,n.jsxs)(s.p,{children:["Under keycloak local host UI, on top right left click drop down and Create Realm .",(0,n.jsx)(s.br,{}),"\n","Browse and upload the extracted version  of the json file.",(0,n.jsx)(s.br,{}),"\n","Relam name should be auto-filled as shown below:"]}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.img,{alt:"kc2",src:a(22678).A+"",width:"1442",height:"726"})}),"\n",(0,n.jsx)(s.h3,{id:"change-client-access-setting-in-keycloak",children:"Change Client Access setting in Keycloak,"}),"\n",(0,n.jsx)(s.p,{children:"Go to Keycloak -> Client -> Client details -> Access setting -> valid redirect URIs"}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.img,{alt:"kc3",src:a(88098).A+"",width:"1128",height:"864"})}),"\n",(0,n.jsx)(s.h3,{id:"check-hasura-system-endpoints-should-already-deployed-when-db-is-deployed",children:"Check Hasura system endpoints (should already deployed when DB is deployed)"}),"\n",(0,n.jsx)(s.p,{children:"go hasura\nsystem -> endpoint"}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.img,{alt:"h3",src:a(14998).A+"",width:"1984",height:"1192"})}),"\n",(0,n.jsx)(s.h3,{id:"reload-hasura-metadata",children:"Reload Hasura metadata"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"hasura --skip-update-check metadata --endpoint <http://localhost:port> --admin-secret <hasura-admin-secret> reload\n"})}),"\n",(0,n.jsx)(s.h3,{id:"create-nats-stream-for-rnr",children:"create nats stream for RnR"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:'// first create context for debezium nats-account\nnats context save debeziumCtx --server=localhost:4222 --user={username} --password={password}\n\n// set the current context\nnats context select debeziumCtx\n\n// create new DebeziumStream\nnats stream add --description="The debezium stream, contains messages which are comming from debezium" --subjects=aoh.aoh_sys.postgres.. --replicas=1 --storage=file --retention=limits --ack --discard=old --dupe-window=2m0s --no-deny-delete --no-deny-purge --no-allow-rollup --max-msgs=-1 --max-msgs-per-subject=-1 --max-bytes=8000000000 --max-age=7d --max-msg-size=-1 --max-consumers=-1 DebeziumStream\n'})})]})}function h(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},14998:(e,s,a)=>{a.d(s,{A:()=>n});const n=a.p+"assets/images/deploy-hasura-endpoint-check-3343f040f4b81d23f7359cb75ab4fb1c.jpg"},88098:(e,s,a)=>{a.d(s,{A:()=>n});const n=a.p+"assets/images/deploy-keycloak-client-redirect-check-14f94b93fb820fdbd5623e605a6ee773.jpg"},22678:(e,s,a)=>{a.d(s,{A:()=>n});const n=a.p+"assets/images/deploy-keycloak-create-realm-check-0c727ddc3b90a5806ba019b70937d464.jpg"},29562:(e,s,a)=>{a.d(s,{A:()=>n});const n=a.p+"assets/images/keycloak_client_details_credentials-c2dba54718c26b041717be8fdac69172.jpg"},28453:(e,s,a)=>{a.d(s,{R:()=>i,x:()=>o});var n=a(96540);const t={},r=n.createContext(t);function i(e){const s=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),n.createElement(r.Provider,{value:s},e.children)}}}]);