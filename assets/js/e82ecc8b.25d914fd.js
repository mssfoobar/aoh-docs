"use strict";(self.webpackChunkaoh_documentation=self.webpackChunkaoh_documentation||[]).push([[5791],{68256:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>t,metadata:()=>a,toc:()=>l});var i=s(74848),r=s(28453);const t={sidebar_position:20},o="\ud83d\udc80 Pitfalls",a={id:"modules/web/reference/pitfalls",title:"\ud83d\udc80 Pitfalls",description:"Common mistakes, errors and pitfalls.",source:"@site/docs/40_modules/20_web/40_reference/20_pitfalls.md",sourceDirName:"40_modules/20_web/40_reference",slug:"/modules/web/reference/pitfalls",permalink:"/aoh-docs/docs/modules/web/reference/pitfalls",draft:!1,unlisted:!1,editUrl:"https://github.com/mssfoobar/aoh-docs/tree/main/docs/40_modules/20_web/40_reference/20_pitfalls.md",tags:[],version:"current",sidebarPosition:20,frontMatter:{sidebar_position:20},sidebar:"web",previous:{title:"\u2714\ufe0f Runbook",permalink:"/aoh-docs/docs/modules/web/reference/runbook"},next:{title:"\ud83d\udd25 Known Issues",permalink:"/aoh-docs/docs/modules/web/reference/known-issues"}},d={},l=[{value:"Svelte &amp; Svelte Kit",id:"svelte--svelte-kit",level:2},{value:"&#39;document&#39; or &#39;window&#39; is not defined",id:"document-or-window-is-not-defined",level:3},{value:"Asynchronous onMount functions",id:"asynchronous-onmount-functions",level:3},{value:"Svelte Store Usage",id:"svelte-store-usage",level:3},{value:"Keying <code>\\{#each}</code> Blocks",id:"keying-each-blocks",level:3},{value:"Testing before merging code with <code>adapter-node</code>",id:"testing-before-merging-code-with-adapter-node",level:3},{value:"Errors when executing <code>npm run dev</code>",id:"errors-when-executing-npm-run-dev",level:3},{value:"Error when executing <code>npm run getschema</code>",id:"error-when-executing-npm-run-getschema",level:3},{value:"Error when executing <code>npm run generate</code>",id:"error-when-executing-npm-run-generate",level:3},{value:"Missing user role",id:"missing-user-role",level:3},{value:"GraphQL",id:"graphql",level:2},{value:"Reusing GraphQL Queries",id:"reusing-graphql-queries",level:3}];function c(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"-pitfalls",children:"\ud83d\udc80 Pitfalls"}),"\n",(0,i.jsx)(n.p,{children:"Common mistakes, errors and pitfalls."}),"\n",(0,i.jsx)(n.h2,{id:"svelte--svelte-kit",children:"Svelte & Svelte Kit"}),"\n",(0,i.jsx)(n.h3,{id:"document-or-window-is-not-defined",children:"'document' or 'window' is not defined"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"'document' or 'window' is not defined"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["SvelteKit has a hybrid server-side-rendering and client-side-rendering model - the initial page is rendered on the\nserver, then subsequent execution of .svelte components is done on the client-side. This method provides a great\nexperience for site visitors but introduces some additional complexity. One important thing to note is that certain\nlibraries depend on the DOM to load (e.g. gridstack.js), loading on the server intially results in errors due to\n",(0,i.jsx)(n.code,{children:"window"})," or ",(0,i.jsx)(n.code,{children:"document"})," not existing on the server (nodejs). To circumvent this, we need to use dynamic imports."]}),"\n",(0,i.jsx)(n.h3,{id:"asynchronous-onmount-functions",children:"Asynchronous onMount functions"}),"\n",(0,i.jsx)(n.p,{children:"If you run an onMount function asynchronously, it returns a promise instead of a function. This will result in the\nreturned 'function' not being called."}),"\n",(0,i.jsxs)(n.p,{children:["See reference discussion: ",(0,i.jsx)(n.a,{href:"https://github.com/sveltejs/svelte/issues/4927",children:"https://github.com/sveltejs/svelte/issues/4927"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",children:'onMount(async () => {\n    bar = await baz();\n\n    return () => {\n        console.log("I\'m never called!");\n    };\n});\n'})}),"\n",(0,i.jsx)(n.p,{children:"To get around this, you can create and run an async function immediately inside onMount:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",children:'onMount(() => {\n    async function foo() {\n        bar = await baz();\n    }\n\n    foo();\n\n    return () => console.log("Now, I do get called when destroyed.");\n});\n'})}),"\n",(0,i.jsx)(n.h3,{id:"svelte-store-usage",children:"Svelte Store Usage"}),"\n",(0,i.jsxs)(n.p,{children:["Any store which is meant to be specific to each individual client only always be set in ",(0,i.jsx)(n.code,{children:"onMount"})," or in a ",(0,i.jsx)(n.code,{children:"is (browser)"}),"\ncheck. This is because stores run on the server are global."]}),"\n",(0,i.jsxs)(n.p,{children:["See reference discussion: ",(0,i.jsx)(n.a,{href:"https://github.com/sveltejs/kit/discussions/4339",children:"https://github.com/sveltejs/kit/discussions/4339"})]}),"\n",(0,i.jsx)(n.admonition,{type:"caution",children:(0,i.jsx)(n.p,{children:"Understanding this is very important for avoiding bugs and potential leaking of sensitive information on the browser.\nPlease look through the linked discussion thoroughly."})}),"\n",(0,i.jsxs)(n.h3,{id:"keying-each-blocks",children:["Keying ",(0,i.jsx)(n.code,{children:"\\{#each}"})," Blocks"]}),"\n",(0,i.jsx)(n.p,{children:"If you use Svelte with any other framework that might manipulate the DOM or have an internal representation of the DOM\n(e.g. GridStack), you will very likely run into issues with this."}),"\n",(0,i.jsxs)(n.p,{children:["See how and why to use ",(0,i.jsx)(n.code,{children:"keyed each blocks"}),": ",(0,i.jsx)(n.a,{href:"https://svelte.dev/tutorial/keyed-each-blocks",children:"https://svelte.dev/tutorial/keyed-each-blocks"})]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"By default, when you modify the value of an each block, it will add and remove items at the end of the block, and update\nany values that have changed. That might not be what you want."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"This will cause the frameworks' representations of the DOM to go out of sync. Adding a unique identifier (or 'key')\nto the each block will allow Svelte to keep track of which element needs to be removed."}),"\n",(0,i.jsxs)(n.h3,{id:"testing-before-merging-code-with-adapter-node",children:["Testing before merging code with ",(0,i.jsx)(n.code,{children:"adapter-node"})]}),"\n",(0,i.jsx)(n.p,{children:"Running the following commands to test your production build is not enough:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm run build\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm run preview\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Since our application is meant to be run on ",(0,i.jsx)(n.code,{children:"nodejs"})," and is built with ",(0,i.jsx)(n.code,{children:"adapter-node"}),", the appropriate way to run the\napp is with:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"node build\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This runs and ",(0,i.jsx)(n.code,{children:"index.js"})," file inside the git-ignored 'build' folder. There is still the potential for your app to fail\nat this point, so please test with ",(0,i.jsx)(n.code,{children:"node build"}),"."]}),"\n",(0,i.jsxs)(n.h3,{id:"errors-when-executing-npm-run-dev",children:["Errors when executing ",(0,i.jsx)(n.code,{children:"npm run dev"})]}),"\n",(0,i.jsx)(n.h1,{id:"err_module_not_found",children:"ERR_MODULE_NOT_FOUND"}),"\n",(0,i.jsx)(n.p,{children:"Sample Error:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"error when starting dev server:\nError [ERR_MODULE_NOT_FOUND]: Cannot find package '...' imported from ...\n"})}),"\n",(0,i.jsx)(n.p,{children:"This type of error (ERR_MODULE_NOT_FOUND) typically happens when a new npm package is included into the project and you were not informed\nof it, or might have forgotten to add/install it. You shouldbe able to resolve it simply by installing the new package."}),"\n",(0,i.jsx)(n.p,{children:"Run:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm install\n"})}),"\n",(0,i.jsxs)(n.h1,{id:"no-matching-export-in-srcgeneratedtypests-for-import-",children:["No matching export in ",(0,i.jsx)(n.code,{children:'"src/generated/types.ts for import "..."'})]}),"\n",(0,i.jsx)(n.p,{children:"Sample Error:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'X [ERROR] No matching export in "src/generated/types.ts" for import "MapDataDocument"\n\n    src/routes/(app)/map-view/+page.ts:4:28:\n      4 \u2502 import { type MapDataQuery, MapDataDocument } from \'$generated-types\';\n'})}),"\n",(0,i.jsxs)(n.p,{children:["You need to run ",(0,i.jsx)(n.code,{children:"npm run generate"})," to generate the types from the GraphQL schema. This is likely to occur when you've\npulled other developers' changes and they might have added new queries to the project."]}),"\n",(0,i.jsxs)(n.h3,{id:"error-when-executing-npm-run-getschema",children:["Error when executing ",(0,i.jsx)(n.code,{children:"npm run getschema"})]}),"\n",(0,i.jsxs)(n.h1,{id:"endpoint-is-required-gq-endpoint",children:["endpoint is required: ",(0,i.jsx)(n.code,{children:"gq <endpoint>"})]}),"\n",(0,i.jsx)(n.p,{children:"Sample Error:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'> @mssfoobar/aoh-web@0.2.0 getschema\n> env-cmd -f .env.development -x gq -H "X-Hasura-Admin-Secret: $PUBLIC_HASURA_ADMIN_KEY" --introspect > schema.graphql\n\n \xbb   Error: endpoint is required: `gq <endpoint>`\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Our usage of the ",(0,i.jsx)(n.code,{children:"gq"})," command (which is 'graphqurl') requires the environment variable ",(0,i.jsx)(n.code,{children:"GRAPHQURL_ENDPOINT"})," - it is not\nset in your ",(0,i.jsx)(n.code,{children:".env.development"})," file, check the\n",(0,i.jsx)(n.a,{href:"https://github.com/mssfoobar/aoh-web/wiki/Environment-Variables",children:"aoh-web wiki"})," on what value you might need to set for\nit."]}),"\n",(0,i.jsxs)(n.h1,{id:"executing-query-error-invalid-x-hasura-admin-secretx-hasura-access-key",children:["Executing query... error: ",(0,i.jsx)(n.code,{children:"invalid x-hasura-admin-secret/x-hasura-access-key"})]}),"\n",(0,i.jsx)(n.p,{children:"Sample Error:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"> @mssfoobar/aoh-web@0.2.0 getschema\n\nExecuting query... error\nError:  {\n  errors: [\n    {\n      extensions: [Object],\n      message: 'invalid x-hasura-admin-secret/x-hasura-access-key'\n    }\n  ]\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Calling the introspection endpoint to get the full schema requires privileged access. You need to set the\n",(0,i.jsx)(n.code,{children:"PUBLIC_HASURA_ADMIN_KEY"})," environment variable in your ",(0,i.jsx)(n.code,{children:".env.development"})," file, check the\n",(0,i.jsx)(n.a,{href:"https://github.com/mssfoobar/aoh-web/wiki/Environment-Variables",children:"aoh-web wiki"})," on what value you might need to set for\nit."]}),"\n",(0,i.jsxs)(n.h3,{id:"error-when-executing-npm-run-generate",children:["Error when executing ",(0,i.jsx)(n.code,{children:"npm run generate"})]}),"\n",(0,i.jsx)(n.p,{children:"Sample Error:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\u2714 Parse Configuration\n\u26a0 Generate outputs\n  \u276f Generate src/generated/types.ts\n    \u2714 Load GraphQL schemas\n    \u2714 Load GraphQL documents\n    \u2716 Not all operations have an unique name: EmergencyDepartmentData\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This error occurs when you run ",(0,i.jsx)(n.code,{children:"npm run generate"})," when you already have generated types, and graphql-codegen seems to attempt to merge the types instead of replace them."]}),"\n",(0,i.jsxs)(n.p,{children:["Delete your ",(0,i.jsx)(n.code,{children:"/src/generated"})," folder (or just the ",(0,i.jsx)(n.code,{children:"/src/generated/types.ts"}),") and run the command again, it should generate the types just fine."]}),"\n",(0,i.jsxs)(n.p,{children:["You can do this by running ",(0,i.jsx)(n.code,{children:"npm run clean"}),", which deletes the generated types."]}),"\n",(0,i.jsx)(n.p,{children:"This can also occur when not all operations have a unique name - especially if you had multiple identical operations in different files, then changed one of them without renaming them (so you really ended up with 2 different operations with the same name)."}),"\n",(0,i.jsx)(n.h3,{id:"missing-user-role",children:"Missing user role"}),"\n",(0,i.jsxs)(n.p,{children:["Users' current role is based on their ",(0,i.jsx)(n.code,{children:"active_membership"})," relationship to a membership they have. This is through the\nforeign key ",(0,i.jsx)(n.code,{children:"membership_id"})," in the ",(0,i.jsx)(n.code,{children:"user_user"})," table. It is highly likely that the user has no active membership set\n(no ",(0,i.jsx)(n.code,{children:"membership_id"})," set). This relationship is used by Keycloak to populate the access token with the claims for the\nuser's role."]}),"\n",(0,i.jsx)(n.h2,{id:"graphql",children:"GraphQL"}),"\n",(0,i.jsx)(n.h3,{id:"reusing-graphql-queries",children:"Reusing GraphQL Queries"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"urql"})," caches queries and uses the same result for operations that have the same queries/subscriptions/mutations."]}),"\n",(0,i.jsx)(n.p,{children:"For example, if you create a subscription like so:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-gql",metastring:'title="Example GraphQL query"',children:"    const ExampleSubscriptionDocument = gql`subscription ExampleSubscription {\n        example_table {\n            id\n        }\n    }`\n"})}),"\n",(0,i.jsx)(n.p,{children:"And mutate it in multiple places:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",metastring:'title="ExampleA/index.svelte"',children:"    pipe(\n        client.subscription<ExampleSubscriptionSubscription>(ExampleSubscriptionDocument. {}),\n        subscribe(async result => {\n            myDataInA = result?.data?.unshift();\n        }\n    );\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",metastring:'title="ExampleB/index.svelte"',children:"    pipe(\n        client.subscription<ExampleSubscriptionSubscription>(ExampleSubscriptionDocument. {}),\n        subscribe(async result => {\n            myDataInB = result?.data?.unshift();\n        }\n    );\n"})}),"\n",(0,i.jsx)(n.p,{children:"The objects in result are actually shared - so mutating the resulting data arrays like in the example above will result\nin the second operation not receiving the same values."}),"\n",(0,i.jsxs)(n.p,{children:["This is because ",(0,i.jsx)(n.code,{children:"urql"})," shares those operations for performance reasons (so we don't need to have multiple operations\nwith the same GraphQL query). This however, means any mutations in one, will affect the other. Knowing this, you should\neither copy out values for queries that will be used in multiple areas, or share the value directly via other mechanisms\n(such as Svelte stores)."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>a});var i=s(96540);const r={},t=i.createContext(r);function o(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);